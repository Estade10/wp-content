var bit_stripe_field=function(){"use strict";return class{#e="";#t="";#s=null;#i=null;#n=null;#r={};#o=null;#l=null;#a=null;#c=null;#d=null;#h=null;#p=null;#y=null;#m=null;#u=null;#f=null;#g=null;#S=null;#b=null;#I=null;#v=[];#E=null;#L=null;constructor(e,t){console.log({config:t}),this.#e="string"==typeof e?document.querySelector(e):e,Object.assign(this.#r,t),this.#t=this.#r.publishableKey,this.#s=this.#r.options,this.#i=this.#r.contentId,this.#o=this.#r.payIntegID,this.#l=this.#r.fieldKey,this.#h=this.#r?.amountFld,this.#p=this.#r?.amount,this.#d=this.#r.amountType,this.#y=this.#r.options.currency,this.#m=`#form-${this.#i}`,this.#u=this.#i?.split("_")[1],this.#S=this.#r.theme.style,this.#b=this.#r.layout,this.#I=this.#r.payBtnTxt,this.#E=this.#r.options?.description,this.#L=this.#r?.address||{},this.init()}init(){this.#w()}#K(e){return document.querySelector(this.#m).querySelector(e)}#w(){const e=this.#K(`.${this.#l}-stripe-btn`);this.#f=this.#K(".stripe-btn-spinner"),this.#$(e,"click",(()=>{this.#f.classList.remove("d-none"),this.#T(this.#i).then((e=>{e&&(console.log({response:e}),this.#_())})).finally((()=>this.#f.classList.add("d-none")))}))}#$(e,t,s){e.addEventListener(t,s),this.#v.push({selector:e,eventType:t,cb:s})}#D(){if(this.#L){const{address:e}=this.#L.defaultValues,t={};return Object.keys(e).map((s=>{t[s]=this.#x(e[s])})),console.log({addressObj:t}),t}}#x(e){if(e){const t=window.bf_globals[this.#i].fields[e]?.fieldName;if(!t)return console.error(`Field name not found for ${e}`);let s=this.#K(`[name="${t}"]`,this.#m);if(s&&"radio"===s.type&&(s=this.#K(`[name="${t}"]:checked`,this.#m)),s&&s.value)return s.value}return""}#V(e=""){const t=bfSelect(`${this.#m} .${this.#l}-err-wrp`),s=bfSelect(`.${this.#l}-err-txt`,t),i=bfSelect(`.${this.#l}-err-msg`,t);if(e){i.style.removeProperty("display"),s.innerHTML=e,setStyleProperty(t,"height",`${s.parentElement.scrollHeight}px`),setStyleProperty(t,"opacity",1);const n=this.#K(`${this.#m} .btcd-fld-itm.${this.#l}`);scrollToElm(n)}else s.innerHTML="",setStyleProperty(i,"display","none"),setStyleProperty(t,"height",0),setStyleProperty(t,"opacity",0)}#_(){const{Stripe:e}=window,t=this.#x(this.#h);if("dynamic"===this.#d&&!t)return void this.#V("Amount field is required");this.#V();const s=100*("fixed"===this.#d?this.#p:t);if(e){this.#c=e(this.#t);const t={payIntegID:this.#o,amount:s,currency:this.#y,metadata:{formID:this.#u,entryID:this.#n,fieldKey:this.#l},payment_method_types:this.#s.payment_method_types,description:this.#E};if("shipping"===this.#L?.mode){if("shipping"in t||(t.shipping={}),"full"===this.#L.display.name)t.shipping.name=this.#x(this.#L.defaultValues.name);else{const e=`${this.#x(this.#L.defaultValues.firstName)} ${this.#x(this.#L.defaultValues.lastName)}`;t.shipping.name=e}this.#L.defaultValues.phone&&(t.shipping.phone=this.#x(this.#L.defaultValues.phone)),t.shipping.address=this.#D()}console.log(t),bitsFetchFront(this.#i,t,"bitforms_get_stripe_secret_key").then((e=>{const{success:t,data:s}=e;if(!t)return void this.#V(s.error.message);this.#V(),this.#e.classList.remove("d-none");const{clientSecret:i}=s,n={appearance:this.#S,clientSecret:i,locale:this.#s.locale};if(this.#a=this.#c.elements(n),this.#g=this.#a.create("payment",{layout:this.#b}),this.#r?.linkAuthentication?.active){const e=this.#x(this.#r.linkAuthentication.emailFld),t=this.#a.create("linkAuthentication",{defaultValues:{email:e}}),s=this.#K(`${this.#m} .${this.#l}-stripe-auth-wrp`);t.mount(s)}if(this.#L.active&&"billing"===this.#L.mode){const{address:e}=this.#r,t=this.#a.create("address",e),s=this.#K(`${this.#m} .${this.#l}-stripe-addr-wrp`);t.mount(s)}this.#g.mount(this.#e),this.#f.classList.add("d-none")})).then((()=>{const e=document.createElement("button");e.innerText=this.#I,e.classList.add("stripe-pay-btn"),e.setAttribute("id","pay-now-btn"),e.setAttribute("type","button");const t=document.createElement("span");t.innerHTML='\n                <svg width="25" height="25" class="pay-spinner d-none" version="1.1" id="L9" xmlns="http://www.w3.org/2000/svg"\n                xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" viewBox="0 0 100 100" enable-background="new 0 0 0 0"\n                xml:space="preserve">\n                <path fill="#fff"\n                  d="M73,50c0-12.7-10.3-23-23-23S27,37.3,27,50 M30.9,50c0-10.5,8.5-19.1,19.1-19.1S69.1,39.5,69.1,50">\n                  <animateTransform attributeName="transform" attributeType="XML" type="rotate" dur="1s" from="0 50 50"\n                    to="360 50 50" repeatCount="indefinite" />\n                </path>\n              </svg>',e.insertAdjacentElement("beforeend",t),this.#e.insertAdjacentElement("beforeend",e),this.#q()}))}}#q(){const e=this.#K("#pay-now-btn"),t=this.#a;this.#$(e,"click",(()=>{const e=this.#K(".pay-spinner");e.classList.remove("d-none"),this.#c.confirmPayment({elements:t,confirmParams:{},redirect:"if_required"}).then((t=>{if(console.log({res:t}),"succeeded"===t?.paymentIntent?.status)e.classList.add("d-none"),this.#P(t.paymentIntent),this.#g.clear();else{const s={data:{[this.#l]:t.error.message}};bfValidationErrMsg(s,this.#i),e.classList.add("d-none")}}))}))}async#T(e){try{await isFormValidatedWithoutError(e)}catch(e){return Promise.reject()}const t=await saveFormProgress(e),s=t?.[e];return s?.success?(s.success&&(this.#n=s.data.entry_id),Promise.resolve(!0)):Promise.reject()}#P(e){const t=document.getElementById(`${this.#i}`);t.classList.add("pos-rel","form-loading");const s=document.getElementById(`form-${this.#i}`);if(null!=s){const i=bf_globals[this.#i];this.#n&&(i.entryId=this.#n);const n=bfSelect(`input[name="${this.#r.fieldKey}"]`,s);n?n.value=e.id:setHiddenFld({name:this.#r.fieldKey,value:e.id,type:"text"},s);let r=bfSelect('button[type="submit"]',s);r||(r=document.createElement("button"),r.setAttribute("type","submit"),r.style.display="none",s.append(r)),r.click();const o={formID:this.#u,transactionID:e.id,payment_name:"stripe",payment_type:"order",payment_response:e,entry_id:this.#n,fieldKey:this.#l},l=new URL(i?.ajaxURL);l.searchParams.append("_ajax_nonce",i?.nonce),l.searchParams.append("action","bitforms_payment_insert"),fetch(l,{method:"POST",body:JSON.stringify(o)}).then((()=>{t.classList.remove("pos-rel","form-loading"),this.#n=null}))}}#M(){this.#v.forEach((({selector:e,eventType:t,cb:s})=>{e.removeEventListener(t,s)}))}destroy(){this.#g?.destroy();const e=this.#K(`.${this.#l}-stripe-fld`),t=this.#K(`.${this.#l}-stripe-auth-wrp`),s=this.#K(`.${this.#l}-stripe-addr-wrp`);e.classList.add("d-none"),e.innerHTML="",this.#e.innerHTML="",t&&(t.innerHTML=""),s&&(s.innerHTML=""),this.#M()}reset(){this.destroy(),this.init()}}}();
